



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Machine Learning models that play by the rules, literally.">
      
      
        <link rel="canonical" href="https://koaning.github.io/human-learn/guide/function-preprocessing.html">
      
      
        <meta name="author" content="Vincent D. Warmerdam">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../icon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Human Preprocessing - Human-Learn</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../style.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#pipe" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://koaning.github.io/human-learn/" title="Human-Learn" aria-label="Human-Learn" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../icon.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Human-Learn
            </span>
            <span class="md-header-nav__topic">
              
                Human Preprocessing
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/koaning/human-learn/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../index.html" class="md-tabs__link">
          Home
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="function-classifier.html" class="md-tabs__link md-tabs__link--active">
          Guides
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../api/classification.html" class="md-tabs__link">
          Api
        </a>
      
    </li>
  

  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://koaning.github.io/human-learn/" title="Human-Learn" class="md-nav__button md-logo">
      
        <img alt="logo" src="../icon.png" width="48" height="48">
      
    </a>
    Human-Learn
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/koaning/human-learn/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Home
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../index.html" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="function-classifier.html" title="Function as a Model" class="md-nav__link">
      Function as a Model
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Human Preprocessing
      </label>
    
    <a href="function-preprocessing.html" title="Human Preprocessing" class="md-nav__link md-nav__link--active">
      Human Preprocessing
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipe" class="md-nav__link">
    Pipe
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#paramaters" class="md-nav__link">
    Paramaters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with-pipe" class="md-nav__link">
    With .pipe()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#without-pipe" class="md-nav__link">
    Without .pipe()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipetransformer" class="md-nav__link">
    PipeTransformer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utility" class="md-nav__link">
    Utility
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dont-remove-data" class="md-nav__link">
    Don't remove data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dont-sort-data" class="md-nav__link">
    Don't sort data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dont-use-lambda" class="md-nav__link">
    Don't use lambda
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Api
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Api
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      Models
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        Models
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../api/classification.html" title="Classification" class="md-nav__link">
      Classification
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/regression.html" title="Regression" class="md-nav__link">
      Regression
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/preprocessing.html" title="Preprocessing" class="md-nav__link">
      Preprocessing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2">
    
    <label class="md-nav__link" for="nav-3-2">
      Utility
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        Utility
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../api/common.html" title="Common" class="md-nav__link">
      Common
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../api/datasets.html" title="Datasets" class="md-nav__link">
      Datasets
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#pipe" class="md-nav__link">
    Pipe
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#paramaters" class="md-nav__link">
    Paramaters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#with-pipe" class="md-nav__link">
    With .pipe()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#without-pipe" class="md-nav__link">
    Without .pipe()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipetransformer" class="md-nav__link">
    PipeTransformer
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utility" class="md-nav__link">
    Utility
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dont-remove-data" class="md-nav__link">
    Don't remove data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dont-sort-data" class="md-nav__link">
    Don't sort data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dont-use-lambda" class="md-nav__link">
    Don't use lambda
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/koaning/human-learn/edit/master/docs/guide/function-preprocessing.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Human Preprocessing</h1>
                
                <p>In python the most popular data analysis tool is pandas while the most popular
tool for making models is scikit-learn. We love the data wrangling tools of pandas
while we appreciate the benchmarking capability of scikit-learn. </p>
<p>The fact that these tools don't fully interact is slightly awkward. The data 
going into the model has an big effect on the output. </p>
<p>So how might we more easily combine the two? </p>
<h2 id="pipe">Pipe<a class="headerlink" href="#pipe" title="Permanent link">&para;</a></h2>
<p>In pandas there's an amazing trick that you can do with the <code>.pipe</code> method. To
demonstrate how this works, let's load in the titanic dataset.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">hulearn.datasets</span> <span class="kn">import</span> <span class="n">load_titanic</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">load_titanic</span><span class="p">(</span><span class="n">as_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;survived&#39;</span><span class="p">]),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;survived&#39;</span><span class="p">]</span>
<span class="n">X</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div>

<p>The <code>X</code> variable represents a dataframe with variables that we're going to use 
to predict the survival rate (stored in <code>y</code>). Here's a preview of what <code>X</code> might have.</p>
<table>
<thead>
<tr>
<th align="right">pclass</th>
<th align="left">name</th>
<th align="left">sex</th>
<th align="right">age</th>
<th align="right">fare</th>
<th align="right">sibsp</th>
<th align="right">parch</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right">3</td>
<td align="left">Braund, Mr. Owen Harris</td>
<td align="left">male</td>
<td align="right">22</td>
<td align="right">7.25</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr>
<td align="right">3</td>
<td align="left">Heikkinen, Miss. Laina</td>
<td align="left">female</td>
<td align="right">26</td>
<td align="right">7.925</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr>
<td align="right">3</td>
<td align="left">Allen, Mr. William Henry</td>
<td align="left">male</td>
<td align="right">35</td>
<td align="right">8.05</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr>
<td align="right">1</td>
<td align="left">McCarthy, Mr. Timothy J</td>
<td align="left">male</td>
<td align="right">54</td>
<td align="right">51.8625</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>Let's say we want to do some preprocessing. Maybe the length of name of somebody
says something about their status so we'd like to capture that. We could add this 
feature with this line of code. </p>
<div class="highlight"><pre><span></span><code><span class="n">X</span><span class="p">[</span><span class="s1">&#39;nchar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
</code></pre></div>

<p>This line of code has downsides though. It changes the original dataset. If we do
a lot of this then our code is going to turn into something unmaintainable rather 
quickly. To prevent this, we might want to change the code into a function. </p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">dataf</span><span class="p">):</span>
    <span class="c1"># Make a copy of the dataframe to prevent it from overwriting the original data.</span>
    <span class="n">dataf</span> <span class="o">=</span> <span class="n">dataf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Make the changes </span>
    <span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;nchar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
    <span class="c1"># Return the name dataframe</span>
    <span class="k">return</span> <span class="n">dataf</span>
</code></pre></div>

<p>We now have a nice function that makes our changes and we can use it like so; </p>
<div class="highlight"><pre><span></span><code><span class="n">X_new</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</code></pre></div>

<p>We can do something more powerful though. </p>
<h3 id="paramaters">Paramaters<a class="headerlink" href="#paramaters" title="Permanent link">&para;</a></h3>
<p>Let's make some more changes to our <code>process</code> function.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">preprocessing</span><span class="p">(</span><span class="n">dataf</span><span class="p">,</span> <span class="n">n_char</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">dataf</span> <span class="o">=</span> <span class="n">dataf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n_char</span><span class="p">:</span>
        <span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;nchar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">gender</span><span class="p">:</span>
        <span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">])</span>
</code></pre></div>

<p>This function works slightly differently now. The most important part is that the 
function now accepts arguments that change the way it behaves internally. The function
also drops the non-numeric columns at the end. </p>
<p>We've changed the way we've defined our function but we're also changing the way
that we're going to apply it. </p>
<div class="highlight"><pre><span></span><code><span class="c1"># This is equivalent to preprocessing(X)</span>
<span class="n">X</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">preprocessing</span><span class="p">)</span>
</code></pre></div>

<p>The benefit of this notation is that if we have more functions that handle
data processing that it would remain a clean overview. </p>
<h3 id="with-pipe">With <code>.pipe()</code><a class="headerlink" href="#with-pipe" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">df</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">set_col_types</span><span class="p">)</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">preprocessing</span><span class="p">,</span> <span class="n">nchar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">add_time_info</span><span class="p">))</span>
</code></pre></div>

<h3 id="without-pipe">Without <code>.pipe()</code><a class="headerlink" href="#without-pipe" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">add_time_info</span><span class="p">(</span><span class="n">preprocessing</span><span class="p">(</span><span class="n">set_col_types</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">nchar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>

<p>Let's be honest, this looks messy. </p>
<h2 id="pipetransformer">PipeTransformer<a class="headerlink" href="#pipetransformer" title="Permanent link">&para;</a></h2>
<p>It would be great if we could use the <code>preprocessing</code>-function as part of a 
scikit-learn pipeline that we can benchmark. It'd be great if we could use 
a function with a pandas <code>.pipe</code>-line in general! </p>
<p>For that we've got another feature in our library, the <code>PipeTransformer</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">hulearn.preprocessing</span> <span class="kn">import</span> <span class="n">PipeTransformer</span>

<span class="k">def</span> <span class="nf">preprocessing</span><span class="p">(</span><span class="n">dataf</span><span class="p">,</span> <span class="n">n_char</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">dataf</span> <span class="o">=</span> <span class="n">dataf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n_char</span><span class="p">:</span>
        <span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;nchar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">gender</span><span class="p">:</span>
        <span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataf</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dataf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">])</span>

<span class="c1"># Important, don&#39;t forget to declare `n_char` and `gender` here.</span>
<span class="n">tfm</span> <span class="o">=</span> <span class="n">PipeTransformer</span><span class="p">(</span><span class="n">preprocessing</span><span class="p">,</span> <span class="n">n_char</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</code></pre></div>

<p>The <code>tfm</code> variable now represents a component that can be used in a scikit-learn
pipeline. We can also perform a cross-validated benchmark on the parameters our
preprocessing function.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.naive_bayes</span> <span class="kn">import</span> <span class="n">GaussianNB</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>


<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;prep&#39;</span><span class="p">,</span> <span class="n">tfm</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;mod&#39;</span><span class="p">,</span> <span class="n">GaussianNB</span><span class="p">())</span>
<span class="p">])</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;prep__n_char&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
    <span class="s2">&quot;prep__gender&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</code></pre></div>

<p>Once trained we can fetch the <code>grid.cv_results_</code> to get a glimpse at
the results of our pipeline.</p>
<table>
<thead>
<tr>
<th align="left">param_prep__gender</th>
<th align="left">param_prep__n_char</th>
<th align="right">mean_test_score</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">True</td>
<td align="left">True</td>
<td align="right">0.785714</td>
</tr>
<tr>
<td align="left">True</td>
<td align="left">False</td>
<td align="right">0.778711</td>
</tr>
<tr>
<td align="left">False</td>
<td align="left">True</td>
<td align="right">0.70028</td>
</tr>
<tr>
<td align="left">False</td>
<td align="left">False</td>
<td align="right">0.67507</td>
</tr>
</tbody>
</table>
<p>It seems that we gender of the passenger has more of an effect on their
survival than the length of their name. </p>
<h2 id="utility">Utility<a class="headerlink" href="#utility" title="Permanent link">&para;</a></h2>
<p>The use-case here has been a relatively simple demonstration on a toy 
dataset but hopefully you can recognize that this opens up a lot of 
flexibility for your machine learning pipelines. You can keep the 
preprocessing interpretable but you can keep everything running by
just writing pandas code. </p>
<p>There's a few small caveats to be aware of. </p>
<h3 id="dont-remove-data">Don't remove data<a class="headerlink" href="#dont-remove-data" title="Permanent link">&para;</a></h3>
<p>Pandas pipelines allow you to filter away rows, scikit-learn on the 
other hand assumes this does not happen. Please be mindful of this. </p>
<h3 id="dont-sort-data">Don't sort data<a class="headerlink" href="#dont-sort-data" title="Permanent link">&para;</a></h3>
<p>You need to keep the order in your dataframe the same because otherwise
it will no longer correspond to the <code>y</code> variable that you're trying to 
predict.</p>
<h3 id="dont-use-lambda">Don't use <code>lambda</code><a class="headerlink" href="#dont-use-lambda" title="Permanent link">&para;</a></h3>
<p>There's two ways that you can add a new column to pandas. </p>
<div class="highlight"><pre><span></span><code><span class="c1"># Method 1</span>
<span class="n">dataf_new</span> <span class="o">=</span> <span class="n">dataf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Don&#39;t overwrite data!</span>
<span class="n">dataf_new</span><span class="p">[</span><span class="s1">&#39;new_column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataf_new</span><span class="p">[</span><span class="s1">&#39;old_column&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> 

<span class="c1"># Method 2  </span>
<span class="n">dataf_new</span> <span class="o">=</span> <span class="n">dataf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;old_column&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div>

<p>In many cases you might argue that method #2 is safer because you
do not need to worry about the <code>dataf.copy()</code> that needs to happen. 
In our case however, we cannot use it. The grid-search no longer works
inside of scikit-learn if you use <code>lambda</code> functions because it cannot
pickle the code. =</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="function-classifier.html" title="Function as a Model" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Function as a Model
              </span>
            </div>
          </a>
        
        
          <a href="../api/classification.html" title="Classification" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Classification
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Maintained by <a href="https://twitter.com/fishnets88">Vincent</a>.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
    
  </body>
</html>