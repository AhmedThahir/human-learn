<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="common.js"></script>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<script>
    // set the dimensions and margins of the graph
    var margin = {top: 10, right: 30, bottom: 30, left: 60},
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;
    
    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

    //Read the data
    all_data = 0;
    d3.csv("peng.csv", function(data) {
      var col1 = "bill_length_mm",
          col2 = "bill_depth_mm";
      var label = "species";
      var uniq_labels = data.map(d => d["species"]).filter(only_unique)

      var color = d3.scaleOrdinal()
        .domain(uniq_labels)
        .range(["#440154ff", "#21908dff", "#fde725ff"])
    
      all_data = data;
    
      // Add X axis
      var x = d3.scaleLinear()
        .domain(calc_norm_extend(data, col1))
        .range([ 0, width ]);

      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));
    
      // Add Y axis
      var y = d3.scaleLinear()
        .domain(calc_norm_extend(data, col2))
        .range([ height, 0]);
      svg.append("g")
        .call(d3.axisLeft(y));
    
      // Add dots
      svg.append('g')
        .attr("class", "point-group")
        .selectAll("dot")
        .data(data)
        .enter()
        .append("circle")
          .attr("cx", function (d) { return x(d[col1]); } )
          .attr("cy", function (d) { return y(d[col2]); } )
          .style("fill", function(d){ return color(d[label])})
          .attr("r", 3.5)

    svg
        .on("mousedown", listen)
        .on("touchstart", listen)
        .on("touchend", ignore)
        .on("touchleave", ignore)
        .on("mouseup", ignore)
        .on("mouseleave", ignore);

    var group_stats = d3.select("g.point-group").node().getBBox();
    var draw_group = svg
        .append("rect")
        .attr("x", group_stats["x"])
        .attr("y", group_stats["y"])
        .attr("width", group_stats["width"])
        .attr("height", group_stats["height"])
        .attr("opacity", 0.0)
        .attr("class", "draw-group");

    function listen(){
        console.log("listen")
    }

    function ignore(){
        console.log("ignore")
    }

    var ptdata = [];
    var session = [];
    var path;
    var points;
    var drawing = false;

    var line = d3.line()
      .x(function(d, i) { return d.x; })
      .y(function(d, i) { return d.y; });

    function listen () {
        drawing = true;
        ptdata = []; // reset point data
        path = svg.append("path") // start a new line
        .data([ptdata])
        .attr("class", "line")
        .attr("d", line)
        .style("opacity", 0.5);

        if (d3.event.type === 'mousedown') {
        svg.on("mousemove", onmove);
        } else {
        svg.on("touchmove", onmove);
        }
    }

    function ignore () {
        var before, after;
        svg.on("mousemove", null);
        svg.on("touchmove", null);

        // skip out if we're not drawing
        if (!drawing) return;
        drawing = false;

        // add newly created line to the drawing session
        session.push(ptdata);
        
        // redraw the line after simplification
        tick();
    }

    function onmove (e) {
        var type = d3.event.type;
        var point;

        if (type === 'mousemove') {
            point = d3.mouse(this);
        } else {
        // only deal with a single touch input
            point = d3.touches(this)[0];
        }

        // push a new data point onto the back
        ptdata.push({ 
            x: point[0], 
            y: point[1], 
            color: "black"
        });
        tick();
    }

    function tick() {
        path.attr("d", function(d) { return line(d); }) // Redraw the path:
        // svg.selectAll("circle").remove();
        svg
            .selectAll("circle")
            .data(session.flat())
            .enter()
            .append("circle")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", 2)
            .style("fill", d => color_map[d.color]);
    }

    function reset(){
        session = [];
        ptdata = [];
        d3.selectAll("path").remove();
        // d3.selectAll("circle").remove();
    }
})
    </script>